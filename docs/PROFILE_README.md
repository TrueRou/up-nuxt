# Profile åŠŸèƒ½å®Œæ•´å®ç°

## æ¦‚è¿°

å·²å®Œæˆç”¨æˆ·èµ„æ–™ï¼ˆProfileï¼‰ç®¡ç†ç³»ç»Ÿçš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ç”¨æˆ·åå¥½è®¾ç½®å’Œè´¦å·ç®¡ç†åŠŸèƒ½ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
up-nuxt/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ composables/
â”‚   â”‚   â””â”€â”€ useProfile.ts              # Profileç®¡ç†Composable
â”‚   â””â”€â”€ pages/
â”‚       â””â”€â”€ profile.vue                # Profileé¡µé¢
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ profile/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.get.ts          # è·å–ç”¨æˆ·èµ„æ–™
â”‚   â”‚   â”‚   â””â”€â”€ index.put.ts          # æ›´æ–°ç”¨æˆ·èµ„æ–™
â”‚   â”‚   â”œâ”€â”€ prober/
â”‚   â”‚   â”‚   â”œâ”€â”€ accounts.get.ts       # è·å–è´¦å·åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ accounts.put.ts       # æ·»åŠ /æ›´æ–°è´¦å·
â”‚   â”‚   â”‚   â””â”€â”€ accounts/
â”‚   â”‚   â”‚       â””â”€â”€ [id].delete.ts    # åˆ é™¤è´¦å·
â”‚   â”‚   â””â”€â”€ servers/
â”‚   â”‚       â””â”€â”€ index.get.ts          # è·å–æœåŠ¡å™¨åˆ—è¡¨
â”‚   â””â”€â”€ database/
â”‚       â””â”€â”€ seeds/
â”‚           â””â”€â”€ servers.sql           # æœåŠ¡å™¨ç¤ºä¾‹æ•°æ®
â”œâ”€â”€ shared/
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ profile.d.ts              # Profileç±»å‹å®šä¹‰
â”œâ”€â”€ i18n/
â”‚   â””â”€â”€ locales/
â”‚       â”œâ”€â”€ zh-CN.json                # ä¸­æ–‡ç¿»è¯‘
â”‚       â””â”€â”€ en-GB.json                # è‹±æ–‡ç¿»è¯‘
â””â”€â”€ docs/
    â”œâ”€â”€ PROFILE_API.md                # APIæ–‡æ¡£
    â”œâ”€â”€ PROFILE_IMPLEMENTATION.md     # å®ç°æ€»ç»“
    â””â”€â”€ PROFILE_TESTING.md            # æµ‹è¯•æŒ‡å—
```

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. ç”¨æˆ·åå¥½è®¾ç½®ï¼ˆPreferenceï¼‰

- âœ… maimaiç‰ˆæœ¬è®¾ç½®
- âœ… ç®€åŒ–ä»£ç 
- âœ… è§’è‰²åç§°
- âœ… å¥½å‹ä»£ç 
- âœ… æ˜¾ç¤ºåç§°
- âœ… DXè¯„åˆ†
- âœ… äºŒç»´ç å¤§å°ï¼ˆ10-30ï¼‰
- âœ… é®ç½©ç±»å‹
- âœ… è§’è‰²ä¿¡æ¯é¢œè‰²ï¼ˆé¢œè‰²é€‰æ‹©å™¨ï¼‰
- âœ… åŠ¨æ€è¯„åˆ†å¼€å…³
- âœ… æ˜¾ç¤ºæ—¥æœŸå¼€å…³
- âœ… è§’è‰²ã€èƒŒæ™¯ã€è¾¹æ¡†ã€é€šè¡Œè¯ID

### 2. è´¦å·ç®¡ç†ï¼ˆAccountsï¼‰

- âœ… æŸ¥çœ‹æ‰€æœ‰è´¦å·
- âœ… æ·»åŠ æ–°è´¦å·
- âœ… æ›´æ–°ç°æœ‰è´¦å·
- âœ… åˆ é™¤è´¦å·
- âœ… å¯ç”¨/ç¦ç”¨è´¦å·
- âœ… è´¦å·æ‰€æœ‰æƒéªŒè¯

### 3. æœåŠ¡å™¨ç®¡ç†

- âœ… è·å–å¯ç”¨æœåŠ¡å™¨åˆ—è¡¨
- âœ… æœåŠ¡å™¨ä¿¡æ¯å±•ç¤º

## ğŸš€ APIç«¯ç‚¹

| æ–¹æ³•   | ç«¯ç‚¹                       | æè¿°           | è®¤è¯ |
|--------|----------------------------|----------------|------|
| GET    | `/api/profile`             | è·å–ç”¨æˆ·èµ„æ–™   | âœ…    |
| PUT    | `/api/profile`             | æ›´æ–°ç”¨æˆ·èµ„æ–™   | âœ…    |
| GET    | `/api/prober/accounts`     | è·å–è´¦å·åˆ—è¡¨   | âœ…    |
| PUT    | `/api/prober/accounts`     | æ·»åŠ /æ›´æ–°è´¦å·  | âœ…    |
| DELETE | `/api/prober/accounts/:id` | åˆ é™¤è´¦å·       | âœ…    |
| GET    | `/api/servers`             | è·å–æœåŠ¡å™¨åˆ—è¡¨ | âŒ    |

## ğŸ“¦ æ•°æ®åº“è¡¨

### tbl_preferenceï¼ˆç”¨æˆ·åå¥½è®¾ç½®ï¼‰

| å­—æ®µ             | ç±»å‹    | é»˜è®¤å€¼  | è¯´æ˜         |
|------------------|---------|---------|--------------|
| user_id          | integer | -       | ç”¨æˆ·IDï¼ˆä¸»é”®ï¼‰ |
| maimai_version   | text    | null    | maimaiç‰ˆæœ¬   |
| simplified_code  | text    | null    | ç®€åŒ–ä»£ç      |
| character_name   | text    | null    | è§’è‰²åç§°     |
| friend_code      | text    | null    | å¥½å‹ä»£ç      |
| display_name     | text    | null    | æ˜¾ç¤ºåç§°     |
| dx_rating        | text    | null    | DXè¯„åˆ†       |
| qr_size          | integer | 15      | äºŒç»´ç å¤§å°   |
| mask_type        | integer | 0       | é®ç½©ç±»å‹     |
| chara_info_color | text    | #fee37c | è§’è‰²ä¿¡æ¯é¢œè‰² |
| dynamic_rating   | boolean | true    | åŠ¨æ€è¯„åˆ†     |
| show_date        | boolean | true    | æ˜¾ç¤ºæ—¥æœŸ     |
| character_id     | text    | null    | è§’è‰²ID       |
| background_id    | text    | null    | èƒŒæ™¯ID       |
| frame_id         | text    | null    | è¾¹æ¡†ID       |
| passname_id      | text    | null    | é€šè¡Œè¯åç§°ID |

### tbl_accountï¼ˆç”¨æˆ·è´¦å·ï¼‰

| å­—æ®µ        | ç±»å‹      | é»˜è®¤å€¼ | è¯´æ˜           |
|-------------|-----------|--------|----------------|
| id          | serial    | -      | è´¦å·IDï¼ˆä¸»é”®ï¼‰   |
| user_id     | integer   | -      | ç”¨æˆ·ID         |
| server_id   | integer   | -      | æœåŠ¡å™¨IDï¼ˆå¤–é”®ï¼‰ |
| credentials | text      | -      | å‡­è¯           |
| enabled     | boolean   | true   | æ˜¯å¦å¯ç”¨       |
| created_at  | timestamp | now()  | åˆ›å»ºæ—¶é—´       |
| updated_at  | timestamp | now()  | æ›´æ–°æ—¶é—´       |

### tbl_serverï¼ˆæœåŠ¡å™¨ï¼‰

| å­—æ®µ                 | ç±»å‹   | è¯´æ˜           |
|----------------------|--------|----------------|
| id                   | serial | æœåŠ¡å™¨IDï¼ˆä¸»é”®ï¼‰ |
| name                 | text   | æœåŠ¡å™¨åç§°     |
| description          | text   | æœåŠ¡å™¨æè¿°     |
| identifier           | text   | æœåŠ¡å™¨æ ‡è¯†ç¬¦   |
| tips_title           | text   | æç¤ºæ ‡é¢˜       |
| tips_desc            | text   | æç¤ºæè¿°       |
| tips_url             | text   | æç¤ºURL        |
| credentials_strategy | text   | å‡­è¯ç­–ç•¥       |
| credentials_field    | text   | å‡­è¯å­—æ®µ       |

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### åœ¨Vueç»„ä»¶ä¸­ä½¿ç”¨Composable

```vue
<script setup>
const { getProfile, updateProfile, getAccounts, getServers } = useProfile()

// è·å–ç”¨æˆ·èµ„æ–™
const profile = await getProfile()

// æ›´æ–°åå¥½è®¾ç½®
await updateProfile({
  preference: {
    displayName: 'æ–°åç§°',
    qrSize: 20,
    dynamicRating: false
  }
})

// è·å–è´¦å·åˆ—è¡¨
const accounts = await getAccounts()

// è·å–æœåŠ¡å™¨åˆ—è¡¨
const servers = await getServers()
</script>
```

### ç›´æ¥è®¿é—®é¡µé¢

è®¿é—® `/profile` é¡µé¢å³å¯æŸ¥çœ‹å’Œç¼–è¾‘ç”¨æˆ·èµ„æ–™ã€‚

## ğŸ” å®‰å…¨æ€§

1. **è®¤è¯ä¿æŠ¤**
   - æ‰€æœ‰APIç«¯ç‚¹éƒ½éœ€è¦ç”¨æˆ·ç™»å½•ï¼ˆé™¤äº†è·å–æœåŠ¡å™¨åˆ—è¡¨ï¼‰
   - ä½¿ç”¨sessionéªŒè¯ç”¨æˆ·èº«ä»½

2. **æƒé™æ§åˆ¶**
   - ç”¨æˆ·åªèƒ½è®¿é—®å’Œä¿®æ”¹è‡ªå·±çš„æ•°æ®
   - æ›´æ–°/åˆ é™¤è´¦å·æ—¶éªŒè¯æ‰€æœ‰æƒ

3. **æ•°æ®éªŒè¯**
   - TypeScriptç±»å‹æ£€æŸ¥
   - æœåŠ¡ç«¯æ•°æ®éªŒè¯

âš ï¸ **æ³¨æ„**: è´¦å·å‡­è¯å½“å‰ä»¥æ˜æ–‡å­˜å‚¨ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®ç°åŠ å¯†ã€‚

## ğŸŒ å›½é™…åŒ–

æ”¯æŒå¤šè¯­è¨€ï¼š
- ä¸­æ–‡ï¼ˆzh-CNï¼‰
- è‹±æ–‡ï¼ˆen-GBï¼‰

æ‰€æœ‰UIæ–‡æœ¬éƒ½å·²ç¿»è¯‘ã€‚

## ğŸ“ æ–‡æ¡£

- **[PROFILE_API.md](./PROFILE_API.md)** - è¯¦ç»†çš„APIæ–‡æ¡£
- **[PROFILE_IMPLEMENTATION.md](./PROFILE_IMPLEMENTATION.md)** - å®ç°ç»†èŠ‚
- **[PROFILE_TESTING.md](./PROFILE_TESTING.md)** - æµ‹è¯•æŒ‡å—

## ğŸ§ª æµ‹è¯•

### å¿«é€Ÿæµ‹è¯•

1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š
   ```bash
   pnpm dev
   ```

2. ç™»å½•ç³»ç»Ÿ

3. è®¿é—® `/profile` é¡µé¢

4. å°è¯•ç¼–è¾‘åå¥½è®¾ç½®å¹¶ä¿å­˜

### APIæµ‹è¯•

ä½¿ç”¨æµè§ˆå™¨æ§åˆ¶å°ï¼š

```javascript
// è·å–èµ„æ–™
const profile = await $fetch('/api/profile')

// æ›´æ–°èµ„æ–™
await $fetch('/api/profile', {
  method: 'PUT',
  body: { preference: { displayName: 'æµ‹è¯•' } }
})
```

è¯¦ç»†æµ‹è¯•æ–¹æ³•è¯·å‚è§ [PROFILE_TESTING.md](./PROFILE_TESTING.md)

## ğŸ—„ï¸ æ•°æ®åº“è®¾ç½®

### è¿è¡Œè¿ç§»

å¦‚æœå°šæœªè¿è¡Œè¿ç§»ï¼š

```bash
pnpm drizzle-kit push
```

### æ’å…¥ç¤ºä¾‹æœåŠ¡å™¨æ•°æ®

```bash
psql $DATABASE_URL < server/database/seeds/servers.sql
```

æˆ–æ‰‹åŠ¨æ‰§è¡Œseeds/servers.sqlä¸­çš„SQLè¯­å¥ã€‚

## ğŸ“Š æ•°æ®æµç¨‹

```
ç”¨æˆ· â†’ Profileé¡µé¢ â†’ useProfile Composable â†’ APIç«¯ç‚¹ â†’ Drizzle ORM â†’ PostgreSQLæ•°æ®åº“
```

### è·å–èµ„æ–™æµç¨‹

1. ç”¨æˆ·è®¿é—® `/profile` é¡µé¢
2. é¡µé¢è°ƒç”¨ `getProfile()` composable
3. å‘é€ GET è¯·æ±‚åˆ° `/api/profile`
4. APIéªŒè¯ç”¨æˆ·èº«ä»½
5. æŸ¥è¯¢æ•°æ®åº“ï¼ˆpreference + accountsï¼‰
6. å¦‚æœpreferenceä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤å€¼
7. è¿”å›å®Œæ•´çš„profileæ•°æ®
8. é¡µé¢å±•ç¤ºæ•°æ®

### æ›´æ–°èµ„æ–™æµç¨‹

1. ç”¨æˆ·ä¿®æ”¹è¡¨å•å¹¶ç‚¹å‡»ä¿å­˜
2. è°ƒç”¨ `updateProfile()` å¹¶ä¼ å…¥æ•°æ®
3. å‘é€ PUT è¯·æ±‚åˆ° `/api/profile`
4. APIéªŒè¯ç”¨æˆ·èº«ä»½
5. æ›´æ–°æ•°æ®åº“ä¸­çš„preferenceè®°å½•
6. è¿”å›æ›´æ–°åçš„å®Œæ•´æ•°æ®
7. é¡µé¢æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. **å®‰å…¨å¢å¼º**
   - å®ç°è´¦å·å‡­è¯åŠ å¯†å­˜å‚¨
   - æ·»åŠ æ“ä½œæ—¥å¿—è®°å½•

2. **åŠŸèƒ½æ‰©å±•**
   - è´¦å·éªŒè¯åŠŸèƒ½
   - æ•°æ®åŒæ­¥åŠŸèƒ½
   - æ‰¹é‡æ“ä½œæ”¯æŒ

3. **ç”¨æˆ·ä½“éªŒ**
   - æ·»åŠ è¡¨å•éªŒè¯
   - å®æ—¶é¢„è§ˆåŠŸèƒ½
   - æ›´å¤šè‡ªå®šä¹‰é€‰é¡¹

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ·»åŠ ç¼“å­˜æœºåˆ¶
   - å®ç°æ•°æ®æ‡’åŠ è½½
   - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢

5. **æµ‹è¯•**
   - ç¼–å†™å•å…ƒæµ‹è¯•
   - æ·»åŠ é›†æˆæµ‹è¯•
   - E2Eæµ‹è¯•

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **401 Unauthorized**
   - ç¡®ä¿å·²ç™»å½•
   - æ£€æŸ¥sessionæ˜¯å¦æœ‰æ•ˆ

2. **404 Not Found**
   - ç¡®è®¤APIç«¯ç‚¹æ­£ç¡®
   - æ£€æŸ¥è·¯ç”±é…ç½®

3. **æ•°æ®åº“é”™è¯¯**
   - æ£€æŸ¥DATABASE_URLç¯å¢ƒå˜é‡
   - ç¡®è®¤æ•°æ®åº“è¿è¡Œä¸­
   - éªŒè¯è¡¨æ˜¯å¦å·²åˆ›å»º

4. **ç±»å‹é”™è¯¯**
   - é‡å¯TypeScriptæœåŠ¡å™¨
   - æ£€æŸ¥ç±»å‹å®šä¹‰æ˜¯å¦æ­£ç¡®å¯¼å…¥

## ğŸ“„ è®¸å¯è¯

æ­¤é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œéµå¾ªé¡¹ç›®ä¸»è®¸å¯è¯ã€‚

## ğŸ‘¥ è´¡çŒ®

æ¬¢è¿æäº¤é—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼
